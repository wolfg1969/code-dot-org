/**
 * Dynamic header generation and event bindings for header actions.
 */

if (!window.dashboard) {
  window.dashboard = {};
}

/**
 * @param scriptData{{
 *   title: string,
 *   finishLink: string,
 *   statsPath: string,
 *   showStageLinks: boolean,
 *   trophies: Object,
 *   scriptId: number,
 *   scriptLevelId: number,
 *   currentLevelIndex: number,
 *   levels: Array.<{
 *     displayText: string,
 *     status: string,
 *     unplugged: boolean,
 *     assessment: boolean
 *   }>
 * }}
 */

dashboard.buildHeader = function (scriptData) {

  function projectNameShow() {
    $('.project_info').empty().append($('<div>').addClass('header_text').text(dashboard.currentApp.name))
        .append($('<div class="project_edit header_button">').text('<%= I18n.t('project.rename') %>'));
  }

  function projectNameEdit() {
    $('.project_info').empty().append($('<input>', {type: 'text'}).addClass('header_input').val(dashboard.currentApp.name))
        .append($('<div class="project_save header_button">').text('<%= I18n.t('project.save') %>'));
  }

  function returnToCourseShow() {
    $('.header_level').empty().append($('<div class="project_exit header_button">').append('<i class="fa fa-arrow-left">')
        .append($('<span>').css('margin-left', '5px').text('<%= I18n.t('project.exit') %>')));
    $('.freeplay_links').before($('<div class="project_list header_button">').text('<%= I18n.t('project.my_projects') %>'));
  }

  $(function () {
    if (window.location.hash && window.location.hash.length > 1) {
      // Try to load a project from the # param
      apps.fetch(window.location.hash.slice(1), function(data) {
        if (data) {
          dashboard.currentApp = data;
          projectNameShow();
          returnToCourseShow();
        }
      });
    } else if (appOptions.level.freePlay) {
      $('.project_info').append($('<div class="project_create header_button">').text('<%= I18n.t('project.create') %>'));
    }
  });

  $(document).on('click', '.project_edit', projectNameEdit);

  $(document).on('click', '.project_save', function () {
    // TODO: apps.update
    projectNameShow();
  });

  $(document).on('click', '.project_exit', function () {
    // TODO: apps.update
    location.hash = '';
    location.reload();
  });

  $(document).on('click', '.project_create', function () {
    // TODO: apps.create
    dashboard.currentApp = {name: 'Untitled'};
    projectNameEdit();
    returnToCourseShow();
  });

  $('.header_text').first().text(scriptData.title);
  if (scriptData.finishLink) {
    $('.header_finished_link').show().append($('<a>').attr('href', scriptData.finishLink.href).text(scriptData.finishLink.text));
  }
  if (scriptData.showStageLinks) {
    $('.header_popup_link').show();
    $('.freeplay_links').show();
  }
  if (scriptData.trophies) {
    $('.header_trophy_link').show();
    $('.header_trophy_link .current_trophies').text(scriptData.trophies.current);
    $('.header_trophy_link .max_trophies').text(scriptData.trophies.of + ' ' + scriptData.trophies.max);
  }
  if (scriptData.linesOfCodeText) {
    $('.header_popup .header_text').text(scriptData.linesOfCodeText);
  }
  var progressContainer = $('.progress_container');
  scriptData.levels.forEach(function(level, index, levels) {
    var defaultClass = level.assessment ? 'puzzle_outer_assessment' : 'puzzle_outer_level';
    var link = $('<a>').attr('href', level.link).addClass('level_link').addClass(level.status).text(level.displayText);
    if (level.unplugged) {
      link.addClass('unplugged_level');
    }
    var div = $('<div>').addClass(index === scriptData.currentLevelIndex ? 'puzzle_outer_current' : defaultClass).append(link);
    if (index === levels.length - 1) {
      div.addClass('last');
    }
    progressContainer.append(div).append('\n');
  });
  $('.level_free_play').qtip({
    content: {
      attr: 'title'
    },
    position: {
      my: 'top center',
      at: 'bottom center'
    }
  });

  function showHeaderPopup(target) {
    $('.header_popup').show();
    $('.header_popup_link_glyph').html('&#x25B2;');
    $('.header_popup_link_text').text('<%= I18n.t(:less) %>');
    $(document).on('click', hideHeaderPopup);
    lazyLoadPopup($(target).closest('.header_trophy_link').length > 0);
  }
  function hideHeaderPopup() {
    $('.header_popup').hide();
    $('.header_popup_link_glyph').html('&#x25BC;');
    $('.header_popup_link_text').text('<%= I18n.t(:more) %>');
    $(document).off('click', hideHeaderPopup);
  }
  $('.header_popup_link, .header_trophy_link').click(function (e) {
    e.stopPropagation();
    $('.header_popup').is(':visible') ? hideHeaderPopup() : showHeaderPopup(e.target);
  });
  $('.header_popup').click(function (e) {
    e.stopPropagation(); // Clicks inside the popup shouldn't close it
  });

  var popupLoaded = false;
  function lazyLoadPopup(trophiesClicked) {
    if (!popupLoaded) {
      popupLoaded = true;
      $.ajax({
        url: scriptData.statsPath,
        data: {
          script_id: scriptData.scriptId,
          script_level_id: scriptData.scriptLevelId
        }, success: function (result) {
          $('.header_popup_body').html(result);
          if (trophiesClicked) {
            jumpToTrophies();
          }
        }
      });
    } else if (trophiesClicked) {
      jumpToTrophies();
    }
  }
  function jumpToTrophies() {
    window.scrollTo(0, +$('#trophies').offset().top);
  }
};
